---
title: "ERASE TB: HIV, malnutrition and non-communicable disease among members of tuberculosis-affected households"
author: "Claire Calderwood"
date: "`r Sys.Date()`"
format:
  docx:
    reference-doc: "Templates/ERASE_draftstyles_reference01.docx"
editor: visual
execute:
  echo: false
  warning: false
fig-cap-location: top
fig-width: 6
fig-asp: 0.618
out-width: "90%"
fig-align: center
fig-dpi: 600
---

```{r projsetup, include=FALSE}
rm(list = ls())

# Directories
datadir = "~/Documents/Datasets/ERASE/" # Where datasets are saved
projdir = "~/OneDrive - London School of Hygiene and Tropical Medicine/ERASE-TB/ERASE_5 Data analysis/ERASE_chronicconditions/" # Working directory
outputdir = paste0(projdir, "Outputs/") # Output of plots etc saved here
 
# Load common functions
source(paste0(projdir, "Scripts/Functions/with_dir.R"))

# Plot settings
colourscheme_blues = c("#abdbe3", "#1e81b0", "#223a74")
colourscheme_reds = c("#FBD7C0", "#e67963", "#c64b35")
colourscheme_greens = c("#B5E4AA", "#34984F", "#1A5222")
colourscheme <- c("#D3D3D3", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
dotsize = 0.4 # Set dot size
plot_fontsize = 8

# Table settings
flextable::set_flextable_defaults(
  font.size = 10, font.family = "Arial",
  padding.top = 1, padding.bottom = 1,
  padding.left = 1, padding.right = 1)
```

```{r filesetup, include=FALSE}
# Packages
library(plyr)
library(tidyverse)
library(janitor)
library(labelled)
library(readxl)
library(kableExtra)
library(hms)
library(lubridate)
library(gtsummary)
library(ggpubr)
library(haven)
library(Hmisc)
library(haven)
library(gt)
library(flextable)
library(survey)
```

\newpage

# Data setup and recruitment

```{r datasetup, include = F}
# Original version

sites = "All" # Select a site, or "Not MMRC" or "All"
spiro_reference = "Other" # Choose from AfrAm, Other, Neutral
spiro_prepost = "pre" # Choose from pre or post BD

# Identify the date that data was last added to the data folder
last_kumbox <- with_dir(
    dir = paste0(datadir, "/ERASE_OC/"),
    expr = list.dirs(full.names = F) %>% max())

source(paste0(projdir, "Scripts/Data setup/erase_chronicconditions_datasetup.R"))
```

```{r readdata, include = F}
df_full <- readRDS(paste0(datadir, "ERASE_processed/", last_kumbox, "/CollEpid", sites, "_", spiro_reference, spiro_prepost, ".Rds"))

df_analysis <- df_full %>%
    filter(completecase == T & completemedhx == T)
```

## Study population

```{r, eval = F}
paste("First recruitment date =", min(df_full$EnrolDate_Use))
paste("Last recruitment date =", max(df_full$EnrolDate_Use))
```

```{r}
# List of PID included in the final analysis dataset
df_analysis %>%
    select(PersID) %>%
    write.csv(. , paste0(outputdir, "ERASE_collepid_persid.csv"))
```

Between `r format(as.Date(min(df_full$EnrolDate_Use)), format = '%B %Y')` and `r format(as.Date(max(df_full$EnrolDate_Use)), format = '%B %Y')`, ...

**N index cases recruited** = `r erase_initial %>% filter(IndexCase_Use == "IndexCase") %>% nrow`

-   Mozambique = `r erase_initial %>% filter(IndexCase_Use == "IndexCase") %>% filter(SiteID == "Ins") %>% nrow`

-   Tanzania = `r erase_initial %>% filter(IndexCase_Use == "IndexCase") %>% filter(SiteID == "Mmrc") %>% nrow`

-   Zimbabwe = `r erase_initial %>% filter(IndexCase_Use == "IndexCase") %>% filter(SiteID == "Brti") %>% nrow`

**Excluded (no HHC**) = `r erase_initial %>% filter(Hhold_Recruited_People == 0) %>% distinct(HholdID) %>% nrow()`

**N households recruited** = `r erase_initial %>% filter(Hhold_Recruited_People > 0) %>% distinct(HholdID) %>% nrow()`

-   Mozambique = `r erase_initial %>% filter(SiteID == "Ins")  %>% filter(Hhold_Recruited_People > 0) %>% distinct(HholdID) %>% nrow()`
-   Tanzania = `r erase_initial %>% filter(SiteID == "Mmrc")  %>% filter(Hhold_Recruited_People > 0) %>% distinct(HholdID) %>% nrow()`
-   Zimbabwe = `r erase_initial %>% filter(SiteID == "Brti")  %>% filter(Hhold_Recruited_People > 0) %>% distinct(HholdID) %>% nrow()`

**N household contacts recruited** = `r df_full %>% nrow()`

-   Mozambique = `r df_full %>% filter(SiteID == "INS") %>% nrow()`

-   Tanzania = `r df_full %>% filter(SiteID == "MMRC") %>% nrow()`

-   Zimbabwe = `r df_full %>% filter(SiteID == "BRTI") %>% nrow()`

```{r}
supptab1_recruitperhh <- erase_initial %>%
    filter(Hhold_Recruited_People > 0) %>%
    distinct(HholdID, .keep_all = T) %>%
    select(Site, Hhold_Total_People, Hhold_Eligible_People, Hhold_Recruited_People) %>%
    tbl_summary(by = "Site",
                digits = all_continuous() ~ 0,
                 statistic = list(all_continuous() ~ "{median} ({p25}-{p75})")) %>%
    add_overall() %>%
    as_flex_table() %>%
    set_table_properties(layout = "autofit")

supptab1_recruitperhh
```

**Excluded =** `r df_full %>% nrow() - df_full %>% filter(completecase == T & completemedhx == T) %>% nrow()`

-   Missing blood tests = `r df_full %>% filter(completecase == F) %>% nrow()`

-   Missing medical history questions = `r df_full %>% filter(completemedhx == F & completecase == T) %>% nrow()`

```{r, eval = F}
# Note: I have done this as per consort diagrams and only given one reason for exclusion; most common reason first
```

**N HHC included in analysis** = `r paste0(df_analysis %>% nrow(), " (", round((df_analysis %>% nrow()) / (df_full %>% nrow())*100), "%)")`

-   Mozambique = `r paste0(df_analysis %>% filter(SiteID == "INS") %>% nrow(), " (", round((df_analysis %>% filter(SiteID == "INS") %>% nrow()) / (df_full %>% filter(SiteID == "INS") %>% nrow())*100), "%)")`

-   Tanzania = `r paste0(df_analysis %>% filter(SiteID == "MMRC") %>% nrow(), " (", round((df_analysis %>% filter(SiteID == "MMRC") %>% nrow()) / (df_full %>% filter(SiteID == "MMRC") %>% nrow())*100), "%)")`

-   Zimbabwe = `r paste0(df_analysis %>% filter(SiteID == "BRTI") %>% nrow(), " (", round((df_analysis %>% filter(SiteID == "BRTI") %>% nrow()) / (df_full %>% filter(SiteID == "BRTI") %>% nrow())*100), "%)")`

`r df_full %>% filter(completecase == T & completemedhx == T) %>% filter(Age_Baseline_Cat_Bin == "10-17 years") %>% nrow()` (`r round(df_full %>% filter(completecase == T & completemedhx == T) %>% filter(Age_Baseline_Cat_Bin == "10-17 years") %>% nrow() / df_full %>% filter(Age_Baseline_Cat_Bin == "10-17 years") %>% nrow() * 100, 0)`%) adolescents and `r df_full %>% filter(completecase == T & completemedhx == T) %>% filter(Age_Baseline_Cat_Bin == "≥ 18 years") %>% nrow()` (`r round(df_full %>% filter(completecase == T & completemedhx == T) %>% filter(Age_Baseline_Cat_Bin == "≥ 18 years") %>% nrow() / df_full %>% filter(Age_Baseline_Cat_Bin == "≥ 18 years") %>% nrow() * 100, 0)`%) adults had complete data available, and were included in the analysis.

```{r}
source(paste0(projdir, "Scripts/Tables/erase_chrcon_missingdatatables.R"))
```

```{r}
temp <- erase_initial %>%
    select(PersID, Q_201_Eos)

list_missing_medhx <- df_full %>%
    left_join(., temp) %>%
    filter(completemedhx == F & completecase == T) %>%
    select(SiteID, PersID, Q_201_Eos)

write.csv(list_missing_medhx, paste0(projdir, "Outputs/ERASE_missing_medhx.csv"))

list_missing_tests <- df_full %>%
    left_join(., temp) %>%
    filter(completecase == F) %>%
    select(SiteID, PersID, Q_201_Eos, HIV_TestResult, HbA1c)

write.csv(list_missing_tests, paste0(projdir, "Outputs/ERASE_missing_tests.csv"))
```

\newpage

```{r datasetup_anon, include=FALSE}
# Create anonymised dataset
set.seed(111) # Different seed to that used for LSHTM data compass

key <- df_analysis %>%
    select(PersID, SiteID, HholdID) %>%
    distinct(HholdID, .keep_all = T) %>%
    group_by(SiteID) %>%
    mutate(hhid=sample.int(n())) %>%
    select(HholdID, hhid)


df_anon <- df_analysis %>%
    left_join(key) %>%
    group_by(Site, hhid) %>%
    mutate(persid = row_number()) %>%
    ungroup() %>%
    mutate(id = paste0(
        substr(Site, start = 1, stop = 1),
        str_pad(hhid, 3, pad = "0", "left"),
        str_pad(persid, 2, pad = "0", "left")),
        Sex_Use = ifelse(Sex_Use == "Women", "Female", "Male")) %>%
    select(
        id,
        Site,
        Sex = Sex_Use,
        Age_Years = Age_Baseline,
        Age_Cat = Age_Baseline_Cat_CJC,
        Education,
        Pregnancy_Status = Pregnancy_Status_Baseline,
        Smoking_Cat_Bin,
        Smoking_PackYears,
        AUDIT_Score_Cat = AUDIT_Score_Cat_CJC,
        InsufficientFood,
        Index_Relation,
        Hhold_Total_People,
        Hhold_Crowding_UN,
        Hhold_Income_Day,
        Hhold_IndexBreadwinner,
        Hhold_Poverty,
        Hhold_ResidenceArea,
        Comorb_TBEver,
        HIV_IndexStatus,
        HIV_Status,
        HIV_Category,
        HIV_CD4_Grade,
        Diabetes_Status,
        Diabetes_Category,
        Diabetes_Grade,
        Hypertension_Status,
        Hypertension_Category,
        Hypertension_Grade,
        BMI_Grade,
        BMI_Underweight,
        BMI_Obese,
        Stunting,
        TB_Status,
        ImpLungFn_Status,
        ImpLungFn_Type,
        ImpLungFn_Grade,
        Anaemia_Status,
        Anaemia_Grade,
        HIV_CD4,
        HbA1c,
        BP_Sys_Overall,
        BP_Dia_Overall,
        Hb) %>%
    select(id, everything())

library(codebookr)
#https://brad-cannell.github.io/codebookr/

# df_anon <- df_anon %>%
#     cb_add_col_attributes(
#         id,
#         description = "ID variable in the format A00101. First letter indicates site, the next 3 digits indicate household and the final digit identifies individuals within households") %>%
#     cb_add_col_attributes(
#         site,
#         description = "Study site") %>%
    
write_csv(df_anon, file =paste0(outputdir, "ERASE_chronicconditions_anondataset.csv")) 

print(codebook(df_anon), paste0(outputdir, "ERASE_chronicconditions_codebook.docx"))
```

# Main tables and figures

```{r}
female_label = paste0("Women (N = ", df_analysis %>% filter(Sex_Use == "Women") %>% nrow(), ")")
male_label = paste0("Men (N = ", df_analysis %>% filter(Sex_Use == "Men") %>% nrow(), ")")
```

### Table 1a: Characteristics of study population (N = `r df_analysis %>% nrow()`)

```{r}
source(paste0(projdir, "Scripts/Tables/erase_chrcon_table1.R"))
```

```{r}
tab1_demsbysite %>%
    set_caption("Characteristics of study participants")
```

\newpage

### Table 1b: Characteristics of study households (N = `r df_analysis %>% distinct(HholdID) %>% nrow()`)

```{r}
tab1_hhcbysite %>%
    set_caption("Characteristics of study households")
```

\newpage

```{r}
# Define variables
categoricalvars <- c("HIV_Status", "HIV_Category", "HIV_CD4_Grade",
           "Diabetes_Status", "Diabetes_Category", "Diabetes_Grade",
           "Hypertension_Status", "Hypertension_Category", "Hypertension_Grade",
           "BMI_Grade", "BMI_Underweight", "BMI_Obese", "Stunting", "TB_Status", "Smoking_Cat", "AUDIT_Score_Cat_CJC",
           "ImpLungFn_Status", "ImpLungFn_Type", "ImpLungFn_Grade", "FVC_Grade", "FEV1FVC_Grade",
           "Anaemia_Status", "Anaemia_Grade")

continuousvars <- c("HIV_CD4", "HbA1c", "BP_Sys_Overall", "BP_Dia_Overall", "Hb")

group = "All"
temp_df <- df_analysis

source(paste0(projdir, "Scripts/Functions/erase_prevalencefn_v2.R"))


source(paste0(projdir, "Scripts/Tables/erase_prevalencetable.R"))

tab2_prevmain <- prevalencetable_main

source(paste0(projdir, "Scripts/Graphs/erase_chrcon_plot_agesex.R"))

plot2_prevmain <- plot_agesex
```

## Previous TB

```{r}
df_analysis %>%
    tabyl(Comorb_TBEver) %>%
    adorn_totals()
```

### Table 2: Chronic conditions among TB household contacts (N = `r df_analysis %>% nrow()`)

```{r}
tab2_prevmain %>%
    mutate(Condition = ifelse(is.na(Condition), as.character(Category), as.character(Condition))
           ) %>%
    select(-Category) %>%
    flextable() %>%
    merge_v(j = ~ Condition) %>%
    valign(j = 1:2, valign = "top", part = "body") %>%
    align(j = 3:8, align = "center", part = "all") %>%
    merge_h(c(1, 19, 24)) %>%
    bold(part = "header") %>%
    style(i = c(1, 19, 24), 
        pr_t = fp_text_default(
          bold = TRUE)) %>%
    bg(i = c(1, 19, 24), bg = "#dadada") %>%
    hline(i = c(1, 18, 19, 23, 24), border = officer::fp_border(color="black", width = 1)) %>%
    set_table_properties(layout = "autofit")
```

**Footnotes:** Values are presented as percentages (for categorical variables) or medians (for continuous variables). BMI categories were created using BMI for age Z-scores among adolescents (\<19 years) with WHO references and absolute BMI thresholds among adults (≥19 years). Mod/severe underweight = Z-score \<-2 or BMI \< 17kg/m2; mild underweight = Z-score ≥-2 & \<-1 or BMI 17-18.49kg/m2; normal weight = Z-score ≥-1 & ≤+1 or BMI 18.5-24.9; overweight = Z-score \>+1 & ≤+2 or BMI 25-29.9 kg/m2; obese = Z-score \>+2 or BMI \>30.0kg/m2. Anaemia was categorised using age and sex-specific thresholds recommended by WHO and described in reference X. Stunting was only calculated among adolescents. Mild stunting was defined as a height of age Z score of \<-1 and ≥-2; moderate stunting as Z score of \<-2 and ≥-3 and severe stunting as Z score \<-3. CD4 counts are only reported among people living with HIV, excluding `r df_analysis %>% filter(is.na(HIV_CD4) & HIV_Status == "Yes") %>% nrow()` people with missing CD4 count (N = `r df_analysis %>% filter(HIV_Status == "Yes") %>% nrow()`).

\newpage

**Notes:**

`r df_analysis %>% filter(Age_Baseline < 18) %>% filter(HIV_Category != "None") %>% nrow()` adolescents had HIV. Among adolescents, `r round(df_analysis %>% filter(Age_Baseline < 18) %>% filter(HIV_Category == "Screening detected") %>% nrow() / df_analysis %>% filter(Age_Baseline < 18) %>% filter(HIV_Category != "None") %>% nrow()*100, 1)`% adolescents were not aware of their HIV status.

```{r}
df_analysis %>%
    mutate(`Any chronic condition` = ifelse(Hypertension_Status == "Yes" | Diabetes_Status == "Yes" | HIV_Status == "Yes" | ImpLungFn_Status == "Yes" | Anaemia_Status == "Yes", "Yes", "No"),
           `Any chronic condition` = ifelse(is.na(`Any chronic condition`), "No", `Any chronic condition`)) %>%
    rowwise() %>%
    mutate(Multimorbidity = sum(Hypertension_Status == "Yes", Diabetes_Status == "Yes", HIV_Status == "Yes", ImpLungFn_Status == "Yes", Anaemia_Status == "Yes", na.rm = T)) %>%
    ungroup() %>%
    mutate(Multimorbidity_bin = ifelse(Multimorbidity >= 2, 'Yes' , 'No')) %>%
    mutate(`Modifiable TB risk factors` = ifelse(Diabetes_Status == "Yes" | HIV_Status == "Yes" | Smoking_Cat == "Current smoker" | AUDIT_Score_Cat == "Positive" | BMI_Underweight == "Yes", "Yes", "No"),
           `Modifiable TB risk factors` = ifelse(is.na(`Modifiable TB risk factors`), "No", `Modifiable TB risk factors`)) %>%
    mutate(`Modifiable TB risk factors in anaemia` = ifelse(Diabetes_Status == "Yes" | HIV_Status == "Yes" | ImpLungFn_Status == "Yes" | Smoking_Cat == "Current smoker" | AUDIT_Score_Cat == "Positive" | BMI_Underweight == "Yes" | Anaemia_Status == "Yes", "Yes", "No"),
           `Modifiable TB risk factors inc anaemia` = ifelse(is.na(`Modifiable TB risk factors in anaemia`), "No", `Modifiable TB risk factors in anaemia`)) %>%
    select(`Any chronic condition`, `Modifiable TB risk factors`, `Modifiable TB risk factors in anaemia`, Multimorbidity_bin, Multimorbidity, Age_Baseline_Cat_Bin, ) %>%
    tbl_summary(by = Age_Baseline_Cat_Bin) %>%
    add_overall() %>%
    as_flex_table() %>%
    add_footer_lines("Footnotes: Any condition is defined as any of HIV, diabetes, hypertension, chronic lung disease or anaemia among adults and HIV, chronic lung disease or anaemia among adolescents. Modifiable TB risk factors were defined as HIV, diabetes, underweight, current smoker or AUDIT score suggestive of hazardous alcohol use. Diabetes was not assessed among adolescents.")

```

```{r, eval = F}
# Mozambique
group = "All"
temp_df <- df_analysis %>%
    filter(SiteID == 'INS')

source(paste0(projdir, "Scripts/Tables/erase_prevalencetable.R"))

tab2_previns <- prevalencetable_main

source(paste0(projdir, "Scripts/Graphs/erase_chrcon_plot_agesex.R"))

plot2_previns <- plot_agesex
```

```{r, eval = F}
# Tanzania
group = "All"
temp_df <- df_analysis %>%
    filter(SiteID == 'MMRC')

source(paste0(projdir, "Scripts/Tables/erase_prevalencetable.R"))

tab2_prevmmrc <- prevalencetable_main

source(paste0(projdir, "Scripts/Graphs/erase_chrcon_plot_agesex.R"))

plot2_prevmmrc <- plot_agesex
```

```{r, eval = F}
# Zimbabwe
group = "All"
temp_df <- df_analysis %>%
    filter(SiteID == 'BRTI')

source(paste0(projdir, "Scripts/Tables/erase_prevalencetable.R"))

tab2_prevbrti <- prevalencetable_main

source(paste0(projdir, "Scripts/Graphs/erase_chrcon_plot_agesex.R"))

plot2_prevbrti <- plot_agesex

plot2_prevsites <- ggarrange(plot2_previns,
          plot2_prevmmrc,
          plot2_prevbrti,
          ncol = 1,
          common.legend = T)
```

```{r}
# Overall by age and sex at the same time
temp_df <- df_analysis

source(paste0(projdir, "Scripts/Tables/erase_prevalencetable_agesex.R"))

source(paste0(projdir, "Scripts/Graphs/erase_chrcon_plot_agesexboth.R"))

plot2_agesexmain <- plot_agesexboth +
    facet_wrap(vars(Sex),
               labeller = labeller(Sex = label_overall %>% deframe))
```

```{r}
# Zimbabwe age and sex at the same time
temp_df <- df_analysis %>%
    filter(SiteID == "BRTI")

source(paste0(projdir, "Scripts/Tables/erase_prevalencetable_agesex.R"))

prevalence_results_agesex <- prevalence_results_agesex %>%
    mutate(Site = "Zimbabwe")

source(paste0(projdir, "Scripts/Graphs/erase_chrcon_plot_agesexboth.R"))

plot2_agesexzim <- plot_agesexboth +
    facet_grid(cols = vars(Sex), rows = vars(Site),
               labeller = labeller(Sex = label_site %>% filter(Site == "Mozambique") %>% dplyr::select(-Site) %>% deframe())) +
    scale_fill_manual(name = "Sex", values=colourscheme_cont) +
    scale_color_manual(name = "Sex", values=colourscheme_cont)
```

```{r}
# Moz age and sex at the same time
temp_df <- df_analysis %>%
    filter(SiteID == "INS")

source(paste0(projdir, "Scripts/Tables/erase_prevalencetable_agesex.R"))

prevalence_results_agesex <- prevalence_results_agesex %>%
    mutate(Site = "Mozambique")

source(paste0(projdir, "Scripts/Graphs/erase_chrcon_plot_agesexboth.R"))

plot2_agesexmoz <- plot_agesexboth +
    facet_grid(cols = vars(Sex), rows = vars(Site),
    labeller = labeller(Sex = label_site %>% filter(Site == "Mozambique") %>% dplyr::select(-Site) %>% deframe())) +
    scale_fill_manual(name = "Sex", values=colourscheme_greens) +
    scale_color_manual(name = "Sex", values=colourscheme_greens)
```

```{r}
# Tanz age and sex at the same time
temp_df <- df_analysis %>%
    filter(SiteID == "MMRC")

source(paste0(projdir, "Scripts/Tables/erase_prevalencetable_agesex.R"))

prevalence_results_agesex <- prevalence_results_agesex %>%
    mutate(Site = "Tanzania")

source(paste0(projdir, "Scripts/Graphs/erase_chrcon_plot_agesexboth.R"))

plot2_agesextanz <- plot_agesexboth +
    facet_grid(cols = vars(Sex), rows = vars(Site),
               labeller = labeller(Sex = label_site %>% filter(Site == "Tanzania") %>% dplyr::select(-Site) %>% deframe())) +
    scale_fill_manual(name = "Sex", values=colourscheme_reds) +
    scale_color_manual(name = "Sex", values=colourscheme_reds)

plot2_agesexsite <- ggarrange(plot2_agesexmoz + 
                                  rremove("x.text") + 
                                  rremove("x.title") +
                                  rremove("x.ticks"),
                              plot2_agesextanz + 
                                  rremove("x.text") + 
                                  rremove("x.title") +
                                  rremove("x.ticks"),
                              plot2_agesexzim,
                              common.legend = T,
                              nrow = 3)
```

\newpage

### Table 3: Prevalence of chronic conditions among TB household contacts, standardised to WHO reference population

```{r}
source(paste0(projdir, "Scripts/Tables/age_standardised_prevalence_version2.R"))

table3_agestandardised %>%
    flextable() %>%
    bold(part = "header") %>%
    align(align = "center", part = "all") %>%
    set_table_properties(layout = "autofit")
```

Confidence intervals were calculated using design-based standard errors within the 'survey' package.

\newpage

### Figure 2: Intersection of chronic conditions among adult TB household contacts

```{r}
#| fig-asp: 1.2
#| out-width: 100%

source(paste0(projdir, "Scripts/Graphs/erase_intersectionplots.R"))

plot_incint_simple

ggsave(plot = plot_incint_simple, file = paste0(outputdir, "plot_incint_simple.svg"), width=11, height=5)

ggsave(plot = plot_incint_simple, file = paste0(outputdir, "plot_incint_simple.jpeg"), width=11, height=7)


```

\newpage

### Figure 3: Cascade of care for HIV, diabetes and hypertension among adult TB household contacts (N = `r df_analysis %>% filter(Age_Baseline >= 18) %>% nrow()`)

```{r}

group = "All"
temp_df <- df_analysis
source(paste0(projdir, "Scripts/Functions/erase_cascadefn.R"))

source(paste0(projdir, "Scripts/Tables/erase_cascade_tabplot.R"))

plot_cascade

ggsave(plot = plot_cascade, file = paste0(outputdir, "plot_cascade.svg"), width=11, height=5)

ggsave(plot = plot_cascade, file = paste0(outputdir, "plot_cascade.jpeg"), width=7, height=5)

```

\newpage

### Table 4: Household clustering of chronic conditions

+---------------------------------+---------------------+------------------------------------------+------------------------------------+---------------+-------------------------------+
|                                 | **Prevalence**\*    | **Prevalence (mixed effects model)\*\*** | **Variance (mixed effects model)** | **VPC\*\*\*** | **P (random effect)\*\*\*\*** |
+---------------------------------+---------------------+------------------------------------------+------------------------------------+---------------+-------------------------------+
| **All participants (N = 1829)** |                     |                                          |                                    |               |                               |
+---------------------------------+---------------------+------------------------------------------+------------------------------------+---------------+-------------------------------+
| HIV\*\*\*\*\*                   | 15.0% (13.2-17.0%)  | 9.5% (7.3-12.4%)                         | 2.26                               | 40.7%         | \<0.001                       |
+---------------------------------+---------------------+------------------------------------------+------------------------------------+---------------+-------------------------------+
| Anaemia                         | 18.0% (16.1-20.1%)  | 14.1% (11.8-16.9%)                       | 1.09                               | 30.0%         | \<0.001                       |
+---------------------------------+---------------------+------------------------------------------+------------------------------------+---------------+-------------------------------+
| Underweight                     | 17.2% (15.4%-19.3%) | 13.8% (11.6%-16.4%)                      | 0.80                               | 19.6%         | \<0.001                       |
+---------------------------------+---------------------+------------------------------------------+------------------------------------+---------------+-------------------------------+
| **Adults (N = 1258)**           |                     |                                          |                                    |               |                               |
+---------------------------------+---------------------+------------------------------------------+------------------------------------+---------------+-------------------------------+
| Diabetes                        | 9.7% (8.1-11.5%)    | 8.3% (5.7-11.8%)                         | 0.48                               | 12.0%         | 0.15                          |
+---------------------------------+---------------------+------------------------------------------+------------------------------------+---------------+-------------------------------+
| Hypertension                    | 32.5% (29.9-35.3%)  | 31.3% (28.3-34.6%)                       | 0.26                               | 7.3%          | 0.05                          |
+---------------------------------+---------------------+------------------------------------------+------------------------------------+---------------+-------------------------------+

**Footnotes:** \* confidence intervals are adjusted for household level using robust standard errors. \*\* Calculated from the intercept and equivalent to a geometric mean. \*\*\* Variance partition coefficient is an estimate of how much residual variation in prevalence is due to unobserved level 2 (household) characteristics. \*\*\* p value for a random effect at level 2 (household level). \*\*\*\*\* Restricting analysis to adults only (to aid comparison with diabetes and hypertension) prev (logistic model) 20.5% (18.1-23.2%), prev (mixed effects model) 13.4% (10.0-17.7%), variance 2.77, VPC 45.7%, p \< 0.001

***This needs rerunning manually to update***

\newpage

# Supplementary materials

## Supplementary methods

### Definition of household contacts

People were eligible to participate in the study if they were aged ≥10 years and living in the same household as someone who had recently (within the past four weeks) been diagnosed with tuberculosis. Living in the same household was defined as spending at least thrre nights per week in the same household as the person with TB.

### Testing for NCDs in ERASE-TB

Due to logistical and regulatory requirements, HbA1c, Hb and blood pressure testing were not available at study initiation and were introduced whilst data collection was ongoing. Where participants were not tested at baseline, we used results obtained at follow up visits (Supplementary table 2). There was no evidence that the distribution of these variables differed between people tested at baseline and those tested during follow up (data not shown).

### Supplementary table 1: Timing of tests for chronic conditions among participants included in analysis, stratified by site (N = `r df_analysis %>% nrow()`)

```{r}
supptab3_visitwresults
```

\newpage

### Definitions for chronic conditions

Definitions for the chronic conditions included in this analysis are shown in supplementary table 2.

For chronic lung disease, the Global Lung Initiative 'Other/mixed' reference standard was used as previously recommended (Refiloe et al). Given a restrictive parttern of spirometry is insufficient for a diagnosis of restrictive lung disease, we did not include this as a crtierion for chronic lung disease in this study (ERS/ATS standards).

Combined BMI categories were created across both adolescents (here defined as \<19 years) and adults, using the terminology usually applied for adult BMI, as shown in supplementary table 3. This approach was selected to aid comparison across all ages included in this study; as the BMI for age thresolds use approximate to the adult cut-offs for an individual aged 19.

Stunting was only calculated among adolescents. Mild stunting was defined as a height of age Z score of \<-1 and ≥-2; moderate stunting as Z score of \<-2 and ≥-3 and severe stunting as Z score \<-3.

Anaemia was categorised using WHO-recommended thresholds, as shown in supplementary table 4.

Blood pressure was categorised according to WHO (all units mmHg): normal, SBP \<130 / DBP\<85; high-normal BP, SBP 130-139 / DBP 85-89; Grade 1 hypertension, SBP 140-159 / DBP 90-99"; Grade 2 hypertension, SBP ≥160 / DBP ≥100.

\newpage

### Supplementary table 2: Definitions for chronic conditions

+--------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| **Condition**            | **Definition**                                                                                                                                                             | **Definition of controlled disease**                                               |
+--------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| **HIV**                  | a\) self-report of previous positive HIV test, or                                                                                                                          | Known HIV on ART and CD4 count ≤350cells/uL                                        |
|                          |                                                                                                                                                                            |                                                                                    |
|                          | b\) self-report of being on ART, or                                                                                                                                        |                                                                                    |
|                          |                                                                                                                                                                            |                                                                                    |
|                          | c\) positive HIV test result                                                                                                                                               |                                                                                    |
+--------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| **Previous TB**          | Self-report of previous TB episode                                                                                                                                         | NA                                                                                 |
+--------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| **TB**                   | Microbiologically-confirmed (Xpert Ultra positive) or clinical diagnosis of TB                                                                                             | TB currently on treatment or completed treatment with successful outcome           |
+--------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| **Anaemia**              | Haemoglobin concentration compatible with any degree of anaemia as shown in supplementary table 4                                                                          | Previously diagnosed with anaemia but Hb in normal range (supplementary table 4)\* |
+--------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| **Chronic lung disease** | a\) Self report of chronic lung disease (asthma, COPD or silicosis)                                                                                                        | NA                                                                                 |
|                          |                                                                                                                                                                            |                                                                                    |
|                          | b\) Obstructive or mixed defect on pre-bronchodilator spirometry (less than lower limit of normal using Global Lung Initiative 'Other/Mixed' ethnicity reference standard) |                                                                                    |
+--------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| **Hypertension**         | a\) self-reported diagnosis of hypertension, or                                                                                                                            | Known hypertension and systolic BP\>140mmHg and diastolic BP \< 90mmHg             |
|                          |                                                                                                                                                                            |                                                                                    |
|                          | b\) self-report of being on anti-hypertensive medications, or                                                                                                              |                                                                                    |
|                          |                                                                                                                                                                            |                                                                                    |
|                          | c\) systolic BP ≥140mmHg, or                                                                                                                                               |                                                                                    |
|                          |                                                                                                                                                                            |                                                                                    |
|                          | d\) diastolic BP ≥90mmHg                                                                                                                                                   |                                                                                    |
+--------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| **Diabetes**             | a\) self-reported diagnosis of diabetes or                                                                                                                                 | Known diabetes with HbA1c \< 6.5%                                                  |
|                          |                                                                                                                                                                            |                                                                                    |
|                          | b\) self-report of being on anti-diabetic medications, or                                                                                                                  |                                                                                    |
|                          |                                                                                                                                                                            |                                                                                    |
|                          | c\) HbA1c ≥6.5%                                                                                                                                                            |                                                                                    |
+--------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+
| **Underweight**          | BMI for age Z score \<-1 among adolescents (\<19 years) and BMI \<18.5kg/m2 among adults (≥19 years)                                                                       | Previously identified as underweight, BMI now in normal range\*                    |
+--------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------+------------------------------------------------------------------------------------+

\*Disease control not assessed for these conditions at baseline.

\newpage

### Supplementary table 3: BMI categories used in this study.

+-----------------------------+-------------------------------------+------------------------------+
| Category                    | Adolescent definintion (\<19 years) | Adult definition (≥19 years) |
|                             |                                     |                              |
|                             | BMI for age Z score thresholds      | Absolute BMI thresholds      |
+=============================+=====================================+==============================+
| Moderate/severe underweight | \<-2                                | \<17 kg/m2                   |
+-----------------------------+-------------------------------------+------------------------------+
| Mild underweight            | ≥-2 & \<-1                          | 17-18.4 kg/m2                |
+-----------------------------+-------------------------------------+------------------------------+
| Normal weight               | ≥-1 & ≤+1                           | 18.5-24.9 kg/m2              |
+-----------------------------+-------------------------------------+------------------------------+
| Overweight                  | \>+1 & ≤+2                          | 25-29.9 kg/m2                |
+-----------------------------+-------------------------------------+------------------------------+
| Obese                       | \>+2                                | ≥30 kg/m2                    |
+-----------------------------+-------------------------------------+------------------------------+

### Supplementary table 4: Classification of anaemia based on haemoglobin concentration (g/L) used in this study

+-------------+--------------------+-------------+--------------+------------------+----------------+
| Population  |                    | Non-anaemia | Mild anaemia | Moderate anaemia | Severe anaemia |
+=============+====================+=============+==============+==================+================+
| 10-11 years |                    | ≥115        | 110-114      | 80-109           | \<70           |
+-------------+--------------------+-------------+--------------+------------------+----------------+
| 12-14 years |                    | ≥120        | 110-119      | 80-109           | \<80           |
+-------------+--------------------+-------------+--------------+------------------+----------------+
| ≥15 years   | Non-pregnant women | ≥120        | 110-119      | 80-109           | \<80           |
+-------------+--------------------+-------------+--------------+------------------+----------------+
|             | Pregnant women     | ≥110        | 100-109      | 70-99            | \<70           |
+-------------+--------------------+-------------+--------------+------------------+----------------+
|             | Men                | ≥130        | 110-129      | 80-109           | \<80           |
+-------------+--------------------+-------------+--------------+------------------+----------------+

### Definitions of other individual-level exposures

AUDIT-C (Alcohol Use Disorder Identification Test) is a three question screening tool that quantifies alcohol misuse. Higher scores correlate with greater severity of alcohol misuse. It was categorised as per the original authors (scores ≥4 among men and ≥3 among women suggest alcohol misuse) (Bush et al 1998).

Crowding was defined as per the United Nations: \[Leyla to add reference\]

Food insecurity was self-report of having had insufficient food in the past 6 months \[check this; could look at how correlates with fies in IMBA data\]

### Definitions of household-level exposures

A threshold of 1.90 United States Dollars (USD) per person per day was used to define poverty in this study this was the international poverty line threshold in 2021 when data collection began. We note that in September 2022 the threshold was increased to 2.15USD (https://pip.worldbank.org).

### Calculation of BMI for age z-scores

BMI for age Z scores were calculated using the WHO reference standard for children and adolescents, and applying the highest reference stratum (that for 19 year olds) to all adults in the study population.

### Packages used for analysis

Calculation of prevalence estimates, including age-standardisation: survey v4.2-1.

Creation of intersection plots: ComplexUpset v1.3.3.

\newpage

### Supplementary table 5: Completed STROBE checklist

+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| **Domain**                | **Item No** | **Recommendation**                                                                                                                                                                                             | **Page N**                  |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Title and abstract        | 1           | (*a*) Indicate the study's design with a commonly used term in the title or the abstract                                                                                                                       | 1                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
|                           | 2           | (*b*) Provide in the abstract an informative and balanced summary of what was done and what was found                                                                                                          | 2                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| **Introduction**          |             |                                                                                                                                                                                                                |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Background/ rationale     | 2           | Explain the scientific background and rationale for the investigation being reported                                                                                                                           | 3                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Objectives                | 3           | State specific objectives, including any prespecified hypotheses                                                                                                                                               | 3                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| **Methods**               |             |                                                                                                                                                                                                                |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Study design              | 4           | Present key elements of study design early in the paper                                                                                                                                                        | 5                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Setting                   | 5           | Describe the setting, locations, and relevant dates, including periods of recruitment, exposure, follow-up, and data collection                                                                                | 4-7                         |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Participants              | 6           | (*a*) Give the eligibility criteria, and the sources and methods of selection of participants                                                                                                                  | 5                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Variables                 | 7           | Clearly define all outcomes, exposures, predictors, potential confounders, and effect modifiers. Give diagnostic criteria, if applicable                                                                       | 6 & supplementary materials |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Data sources/ measurement | 8           | For each variable of interest, give sources of data and details of methods of assessment (measurement). Describe comparability of assessment methods if there is more than one group                           | 5                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Bias                      | 9           | Describe any efforts to address potential sources of bias                                                                                                                                                      | 14                          |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Study size                | 10          | Explain how the study size was arrived at                                                                                                                                                                      | 5                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Quantitative variables    | 11          | Explain how quantitative variables were handled in the analyses. If applicable, describe which groupings were chosen and why                                                                                   | 6 & supplementary materials |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Statistical methods       | 12          | (*a*) Describe all statistical methods, including those used to control for confounding                                                                                                                        | 6                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
|                           |             | (*b*) Describe any methods used to examine subgroups and interactions                                                                                                                                          |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
|                           |             | (*c*) Explain how missing data were addressed                                                                                                                                                                  |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
|                           |             | (*d*) If applicable, describe analytical methods taking account of sampling strategy                                                                                                                           |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
|                           |             | ([*e*]{.underline}) Describe any sensitivity analyses                                                                                                                                                          |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| **Results**               |             |                                                                                                                                                                                                                |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Participants              | 13\*        | \(a\) Report numbers of individuals at each stage of study---eg numbers potentially eligible, examined for eligibility, confirmed eligible, included in the study, completing follow-up, and analysed          |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
|                           |             | \(b\) Give reasons for non-participation at each stage                                                                                                                                                         |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
|                           |             | \(c\) Consider use of a flow diagram                                                                                                                                                                           |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Descriptive data          | 14\*        | \(a\) Give characteristics of study participants (eg demographic, clinical, social) and information on exposures and potential confounders                                                                     |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
|                           |             | \(b\) Indicate number of participants with missing data for each variable of interest                                                                                                                          |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Outcome data              | 15\*        | Report numbers of outcome events or summary measures                                                                                                                                                           | 9                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Main results              | 16          | (*a*) Give unadjusted estimates and, if applicable, confounder-adjusted estimates and their precision (eg, 95% confidence interval). Make clear which confounders were adjusted for and why they were included |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
|                           |             | (*b*) Report category boundaries when continuous variables were categorized                                                                                                                                    |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
|                           |             | (*c*) If relevant, consider translating estimates of relative risk into absolute risk for a meaningful time period                                                                                             | NA                          |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Other analyses            | 17          | Report other analyses done---eg analyses of subgroups and interactions, and sensitivity analyses                                                                                                               | 8-9                         |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| **Discussion**            |             |                                                                                                                                                                                                                |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Key results               | 18          | Summarise key results with reference to study objectives                                                                                                                                                       | 9                           |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Limitations               | 19          | Discuss limitations of the study, taking into account sources of potential bias or imprecision. Discuss both direction and magnitude of any potential bias                                                     | 13                          |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Interpretation            | 20          | Give a cautious overall interpretation of results considering objectives, limitations, multiplicity of analyses, results from similar studies, and other relevant evidence                                     | 9-12                        |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Generalisability          | 21          | Discuss the generalisability (external validity) of the study results                                                                                                                                          | 11                          |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| **Other information**     |             |                                                                                                                                                                                                                |                             |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+
| Funding                   | 22          | Give the source of funding and the role of the funders for the present study and, if applicable, for the original study on which the present article is based                                                  | 14                          |
+---------------------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+-----------------------------+

\newpage

### Supplementary table 6: Estimates of chronic condition prevalence from population-representative surveys

***Needs finishing - add in 'increased risk of TB column'***

+----------------------------------------------------------------------------------------------------+---------------+--------------------------------------------------+--------------------------------------------------+--------------------------------------------------+-----------------------------------------------+
|                                                                                                    | ***WHO AFR*** | ***Mozambique***                                 | ***Tanzania***                                   | ***Zimbabwe***                                   | ***Increased risk of TB***                    |
+----------------------------------------------------------------------------------------------------+---------------+--------------------------------------------------+--------------------------------------------------+--------------------------------------------------+-----------------------------------------------+
| *HIV^\*^*                                                                                          |               | *12.5% (INSIAD 2021)*                            | *5% (THIS 2017)*                                 | *12% (ZimPHIA 2020)*                             | RR 18 (range, 15--21) (Global TB report 2020) |
+----------------------------------------------------------------------------------------------------+---------------+--------------------------------------------------+--------------------------------------------------+--------------------------------------------------+-----------------------------------------------+
| *Diabetes^\*\*^*                                                                                   |               | *2.4% (IDF 2021) -- 3.3% age standardised*       | *10.3% (IDF 2021) -- 12.3% age standardised*     | *1.5% (IDF 2021) -- 2.1% age standardised*       | *OR 2.3*^17^                                  |
+----------------------------------------------------------------------------------------------------+---------------+--------------------------------------------------+--------------------------------------------------+--------------------------------------------------+-----------------------------------------------+
| *Hypertension^\*\*\*^*                                                                             |               | *34.3% (WHO GHO 2019) -- age standardised 38.6%* | *30.9% (WHO GHO 2019) -- age standardised 33.2%* | *37.6% (WHO GHO 2019) -- age standardised 42.3%* | NR                                            |
+----------------------------------------------------------------------------------------------------+---------------+--------------------------------------------------+--------------------------------------------------+--------------------------------------------------+-----------------------------------------------+
| *Underweight*\*\*\*\*                                                                              |               | *Thinness: 4.2% boys and 2.8% girls*             |                                                  |                                                  | OR 4.96 (Badawi 2020)                         |
|                                                                                                    |               |                                                  |                                                  |                                                  |                                               |
|                                                                                                    |               | Adults 12.0% men and 9.9% women                  |                                                  |                                                  |                                               |
|                                                                                                    |               |                                                  |                                                  |                                                  |                                               |
|                                                                                                    |               | 2016                                             |                                                  |                                                  |                                               |
+----------------------------------------------------------------------------------------------------+---------------+--------------------------------------------------+--------------------------------------------------+--------------------------------------------------+-----------------------------------------------+
| Overweight + obesity\*\*\*\*                                                                       |               | 17.0% + 3.0% girls and 7.8% + 1.3% boys          |                                                  |                                                  | OR 0.26 (obesity) (Badawi 2020)               |
|                                                                                                    |               |                                                  |                                                  |                                                  |                                               |
|                                                                                                    |               | 33.6% + 10.5% women and 18.0 + 3.3% men          |                                                  |                                                  |                                               |
|                                                                                                    |               |                                                  |                                                  |                                                  |                                               |
|                                                                                                    |               | 2016                                             |                                                  |                                                  |                                               |
+----------------------------------------------------------------------------------------------------+---------------+--------------------------------------------------+--------------------------------------------------+--------------------------------------------------+-----------------------------------------------+
| *Anaemia\*\*\*\**                                                                                  |               | 47.9% women                                      |                                                  |                                                  | 2.01 (95% CI 1.70-2.37) (Gelaw 2021)          |
+----------------------------------------------------------------------------------------------------+---------------+--------------------------------------------------+--------------------------------------------------+--------------------------------------------------+-----------------------------------------------+
| *Heavy episodic drinking = WHO indicator = 6 more more drinks on one occasion in the past 30 days* | *17.4%*       | *8.7%*                                           | *19.4%*                                          | *8.3%*                                           | *RR (alcohol use) 1.35*                       |
|                                                                                                    |               |                                                  |                                                  |                                                  |                                               |
|                                                                                                    |               |                                                  |                                                  |                                                  | *RR (alcohol-related problems) 3.33*^18^      |
+----------------------------------------------------------------------------------------------------+---------------+--------------------------------------------------+--------------------------------------------------+--------------------------------------------------+-----------------------------------------------+
| *Smoking*                                                                                          |               |                                                  |                                                  |                                                  |                                               |
+----------------------------------------------------------------------------------------------------+---------------+--------------------------------------------------+--------------------------------------------------+--------------------------------------------------+-----------------------------------------------+

*Footnotes: \* Data are from population-representative HIV prevalence surveys including adults aged 15 and older. \*\* International Diabetes Federation estimates for adults 20­--79 years.*^19^

*\*\*\* World Health Organization Global Health Observatory data for adults aged 30--79 years.*

\*\*\*\* https://globalnutritionreport.org/resources/nutrition-profiles/africa/eastern-africa/mozambique/ Children and adolescents 5-19 years

\newpage

## Supplementary results

### Supplementary table 7: Missing data for tests for chronic conditions in study population, stratified by site (N = `r df_full %>% nrow()`)

```{r}
supptab2_missingresults
```

`r df_analysis %>% filter(complete.cases(ImpLungFn_Type)) %>% nrow()` participants (`r df_analysis %>% filter(complete.cases(ImpLungFn_Type)) %>% nrow()/df_analysis %>% nrow()`%) participants included in the analysis dataset had an adequate quality spirometry result available.

\newpage

### Supplementary table 8: Characteristics of study participants included and excluded from analysis dataset, stratified by study site (N = `r df_analysis %>% nrow()`)

```{r}
supptab4_incvsexc
```

\newpage

### Supplementary table 9a: Participant characteristics stratified by sex (N = `r df_analysis %>% nrow()`)

```{r}
tab1_demsbysex
```

Note adolescent drinking

```{r}
df_analysis %>% tabyl(Age_Baseline_Cat_CJC, AUDIT_Score_Cat_CJC) %>% adorn_percentages("row") %>% adorn_pct_formatting() %>% adorn_ns()
```

\newpage

### Supplementary table 9b: Participant characteristics stratified by site and sex (N = `r df_analysis %>% nrow()`)

```{r}
tab1_demsbysexsite
```

\newpage

### Supplementary figure 1: Age distribution of household contacts, relative to the index case (N = `r df_analysis %>% nrow()`)

```{r}
temp <- erase_initial %>%
    filter(IndexCase_Use == "IndexCase") %>%
    mutate(Age_Index = Age_Baseline) %>%
    select(HholdID, Age_Index)

temp2 <- erase_initial %>%
    left_join(., temp, by = "HholdID") %>%
    mutate(`Age difference / years` = Age_Baseline - Age_Index)

plot_agediffbysex <- temp2 %>%
    mutate(sex = case_when(
               Sex_Use == "female" ~ female_label,
               Sex_Use == "male" ~ male_label)) %>%
    filter(IndexCase_Use == "Hhold contact") %>%
    ggplot(aes(`Age difference / years`, col = sex, fill = sex)) +
    geom_histogram(binwidth = 1) +
    theme_pubr(border = T) +
    facet_wrap(vars(sex)) +
    scale_fill_manual(values = colourscheme_greens[2:3]) +
    scale_color_manual(values = colourscheme_greens[2:3]) +
    guides(fill = FALSE, col = FALSE) +
    labs(y = "N") +
    theme(text = element_text(size = plot_fontsize))

plot_agediffbysex
```

\newpage

### Supplementary table 10: Chronic conditions among TB household contacts, stratified by sex and age category, including confidence intervals (N = `r df_analysis %>% nrow()`)

```{r}
#| label: tbl-s2prevwithci
#| tbl-cap: Prevalence of chronic conditions among TB household contacts

prevalencetable_supplement %>%
    mutate(Condition = ifelse(is.na(Condition), as.character(Category), as.character(Condition)),
           #Level = ifelse(is.na(Level), as.character(Condition), as.character(Level)),
           Level = case_when(
               Level == "Normal, SBP <130 / DBP<85" ~ "Normal BP",
               Level == "Prehypertension, SBP 130-139 / DBP 85-89" ~ "High-normal BP",
               Level == "Grade 1 hypertension, SBP 140-159 / DBP 90-99" ~ "Grade 1 hypertension",
               Level == "Grade 2 hypertension, SBP ≥160 / DBP ≥100" ~ "Grade 2 hypertension",
           complete.cases(Level) ~ as.character(Level))) %>%
    select(-Category) %>%
    flextable() %>%
    merge_v(j = ~ Condition) %>%
    valign(j = 1:2, valign = "top", part = "body") %>%
    align(j = 3:8, align = "center", part = "all") %>%
    merge_h(c(1, 19, 24)) %>%
    bold(part = "header") %>%
    style(i = c(1, 19, 24), 
        pr_t = fp_text_default(
          bold = TRUE)) %>%
    bg(i = c(1, 19, 24), bg = "#dadada") %>%
    hline(i = c(1, 18, 19, 23, 24), border = officer::fp_border(color="black", width = 1)) %>%
    set_table_properties(layout = "autofit")
```

```{r}
df_analysis %>%
    tabyl(HIV_Status, HIV_CD4_Grade)

183+93+13
```

\newpage

### Supplementary table 11: Chronic conditions among TB household contacts, stratified by site (N = `r df_analysis %>% nrow()`)

```{r}
prevalencetable_bysite %>%
    mutate(Condition = ifelse(is.na(Condition), as.character(Category), as.character(Condition)),
           #Condition = case_when(
        #       Condition == "Diabetes" ~ "Elevated HbA1c",
        #       Condition == "Hypertension" ~ "Elevated BP",
        #       complete.cases(Condition) ~ Condition),
           #Level = ifelse(is.na(Level), as.character(Condition), as.character(Level)),
           Level = case_when(
               Level == "Normal, SBP <130 / DBP<85" ~ "Normal BP",
               Level == "Prehypertension, SBP 130-139 / DBP 85-89" ~ "High-normal BP",
               Level == "Grade 1 hypertension, SBP 140-159 / DBP 90-99" ~ "Grade 1 hypertension",
               Level == "Grade 2 hypertension, SBP ≥160 / DBP ≥100" ~ "Grade 2 hypertension",
           complete.cases(Level) ~ as.character(Level))) %>%
    select(-Category) %>%
    flextable() %>%
    merge_v(j = ~ Condition) %>%
    valign(j = 1:2, valign = "top", part = "body") %>%
    align(j = 3:6, align = "center", part = "all") %>%
    merge_h(c(1, 19, 24)) %>%
    bold(part = "header") %>%
    style(i = c(1, 19, 24), 
        pr_t = fp_text_default(
          bold = TRUE)) %>%
    bg(i = c(1, 19, 24), bg = "#dadada") %>%
    hline(i = c(1, 18, 19, 23, 24), border = officer::fp_border(color="black", width = 1)) %>%
    set_table_properties(layout = "autofit")
```

\newpage

### Supplementary figure 2: Prevalence of chronic conditions among TB household contacts stratified by age category and sex (N = `r df_analysis %>% nrow()`)

```{r}
plot2_agesexmain
```

\newpage

### Supplementary figure 3: Prevalence of chronic conditions among TB household contacts stratified by age category, sex and study site

```{r}
#| fig-asp: 1.2
plot2_agesexsite
```

\newpage

### Supplementary table 12: Site specific age-standardised prevavalence of chronic conditions

```{r}
table3_agestandardised_site %>%
    flextable() %>%
    separate_header()
```

\newpage

### Supplementary figure 4: Association between HbA1c, systolic BP and diastolic BP, and age

```{r}
#| fig-asp: 1.2
temp_parta <- df_analysis %>%
    ggplot(aes(x = Age_Baseline, y = HbA1c, col = Sex_Use, fill = Sex_Use)) +
    geom_hline(yintercept = 6.5, linetype = "dashed", colour = "darkgrey") +
    geom_point(size = dotsize) +
    geom_smooth(method = "lm", linewidth = dotsize) +
    scale_color_manual(name = "Sex", values = colourscheme_greens[2:3]) +
    scale_fill_manual(name = "Sex", values = colourscheme_greens[2:3]) +
    scale_y_continuous(breaks = c(4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5,8),
                       limits = c(4,8)) +
    scale_x_continuous(breaks = c(20, 40, 60, 80), limits = c(18, 85)) +
    theme_pubr(border = T, legend = "right") +
    theme(text = element_text(size = plot_fontsize)) +
    labs(y = "HbA1c (%)", x = "Age (years)")

temp_partb <- df_analysis %>%
    ggplot(aes(x = Age_Baseline, y = BP_Sys_Overall, col = Sex_Use, fill = Sex_Use)) +
    geom_hline(yintercept = 140, linetype = "dashed", colour = "darkgrey") +
    geom_point(size = dotsize) +
    geom_smooth(method = "lm", linewidth = dotsize) +
    scale_color_manual(name = "Sex", values = colourscheme_greens[2:3]) +
    scale_fill_manual(name = "Sex", values = colourscheme_greens[2:3]) +
    scale_y_continuous(breaks = c(80, 100, 120, 140, 160, 180, 200)) +
    theme_pubr(border = T, legend = "right") +
    theme(text = element_text(size = plot_fontsize)) +
    labs(y = "Systolic BP (mmHg)", x = "Age (years)")

temp_partc <- df_analysis %>%
    ggplot(aes(x = Age_Baseline, y = BP_Dia_Overall, col = Sex_Use, fill = Sex_Use)) +
    geom_hline(yintercept = 90, linetype = "dashed", colour = "darkgrey") +
    geom_point(size = dotsize) +
    geom_smooth(method = "lm", linewidth = dotsize) +
    scale_color_manual(name = "Sex", values = colourscheme_greens[2:3]) +
    scale_fill_manual(name = "Sex", values = colourscheme_greens[2:3]) +
    scale_y_continuous(breaks = c(20, 40, 60, 80, 100, 120, 140, 160, 180, 200)) +
    theme_pubr(border = T, legend = "right") +
    theme(text = element_text(size = plot_fontsize)) +
    labs(y = "Diastolic BP (mmHg)", x = "Age (years)")

ggarrange(temp_parta, temp_partb, temp_partc, common.legend = T, ncol = 1)
```

Footnotes: `r df_analysis %>% filter(HbA1c > 8) %>% nrow()` HbA1c results \>8.0% not displayed.

\newpage

```{r, include = F}
source(paste0(projdir, "Scripts/Graphs/erase_nutritiondistributions.R"))
```

### Supplementary figure 5: Association between HbA1c, systolic and diastolic BP and BMI category

```{r}
fig_htndmbybmi
```

```{r, include = F}
table_htnbybmi %>%
    dplyr::rename(`No hypertension` = No, Hypertension = Yes, `BMI category` = BMI_Grade) %>%
    flextable()
```

```{r, include = F}
table_diabetesbybmi %>%
    dplyr::rename(`No diabetes` = No, Diabetes = Yes, `BMI category` = BMI_Grade) %>%
    flextable()
```

\newpage

### Supplementary figure 6: BMI distribution by age

```{r}
#| fig-asp: 1.2

ggarrange(plot_bmibyagecat,
          plot_bmibyage, ncol = 1)
```

\newpage

### Supplementary table 13: Prevalence of HIV among household contacts, stratified by HIV status of the index case

```{r}
res_prev_hivposindex <- df_analysis %>%
    filter(str_detect(HIV_IndexStatus, "Positive")) %>% droplevels() %>%
    calculate_proportions(., condition_variables = c("HIV_Status", "HIV_Category"), household_id_var = "HholdID") %>%
    mutate(Stratum = "HIV positive index case")

res_prev_hivnegindex <- df_analysis %>%
    filter(str_detect(HIV_IndexStatus, "Negative")) %>% droplevels() %>%
    calculate_proportions(., condition_variables = c("HIV_Status", "HIV_Category"), household_id_var = "HholdID") %>%
    mutate(Stratum = "HIV negative index case")
    
prevelance_indexhiv <- rbind(res_prev_hivposindex, res_prev_hivnegindex)

prevelance_indexhiv %>%
    filter(Level != "No") %>%
    filter(Level != "None") %>%
    mutate(Level = ifelse(Level == "Yes", "Prevalence", Level),
           Condition = str_remove(Condition, "_Status"),
           Condition = str_remove(Condition, "_Category")) %>%
    select(Condition, Level, anN = n_N, EstimateCI = Estimate_CI, Stratum) %>%
    pivot_wider(names_from = Stratum,
                values_from = c(anN, EstimateCI),
                names_glue = "{Stratum}_{.value}") %>%
    select(order(colnames(.))) %>%
    select(Condition, Level, everything()) %>%
    flextable() %>%
    separate_header() %>%
    align(align = "center", part = "all") %>%
    merge_v(j = c(1,2)) %>%
    #add_footer_lines(values = footer_bmi_note) %>%
    set_table_properties(layout = "autofit")
```

\newpage

### Supplementary table 14: Cascade of care for HIV, diabetes and hypertension

```{r}
table_cascade %>%
    flextable() %>%
    merge_v() %>%
    separate_header("center-hspan")
```

\newpage

### Supplementary figure 7: Cascade of care for HIV, diabetes and hypertension, stratified by study site

```{r}
plot_cascade_site +
    scale_fill_manual(values=c("#34984F",  "#e67963", "#1e81b0"))
```

\newpage

### Supplementary table 15: Prevalence of chronic conditions at household level

```{r}
df_analysis %>%
    distinct(HholdID, .keep_all = T) %>%
    select(
        Site,
        HIV = Hhold_HIVStatus,
           Diabetes = Hhold_DiabStatus,
           Hypertension = Hhold_HypertensionStatus,
           `Either diabetes or hypertension` = Hhold_NCDStatus,
           Underweight = Hhold_UWStatus,
           Stunting = Hhold_StStatus,
           `Overweight/obesity` = Hhold_ObsStatus) %>%
    tbl_summary(by = Site) %>%
    add_overall() %>%
    as_flex_table() %>%
    hline(i = c(1, 4), border = officer::fp_border(color="black", width = 1)) %>%
    set_table_properties(layout = "autofit")
```

**Footnotes:** \* The double burden of malnutrition is defined as someone who is underweight or has stunting and someone who is overweight or obese living in the same household.

### Supplementary figure 8: Overlap of underweight, stunting and overweight/obesity at household level

```{r}
library(eulerr)

euler <- df_analysis %>%
    distinct(HholdID, .keep_all = T) %>%
    select(Hhold_UWStatus, Hhold_StStatus, Hhold_ObsStatus) %>%
    group_by(Hhold_UWStatus, Hhold_StStatus, Hhold_ObsStatus) %>%
    dplyr::summarise(N = n()) %>%
    mutate(percent = N/sum(N)) %>%
    mutate(
        Underweight = ifelse(Hhold_UWStatus == 1, "Underweight", NA),
        Stunting = ifelse(Hhold_StStatus == 1, "Stunting", NA),
        Obesity = ifelse(Hhold_ObsStatus == 1, "Obesity", NA)) %>%
    unite("all", Underweight:Obesity, na.rm = TRUE, sep = "&") %>%
    mutate(all = ifelse(all=='', "None", all)) %>%
    mutate(cat = ifelse(str_detect(all, "&"), "Multiple", all)) %>%
    ungroup()

## 1
euler2 <- euler %>%
    select(all, N) %>%
    deframe()

plot1 <- plot(euler(euler2,
           input = "disjoint"), quantities = list(type = "percent", cex = 1))

plot1
```

```{r}
source(paste0(projdir, "Scripts/Tables/erase_altdmdefinition.R"))
```

\newpage

## Additional tables for peer review

### Table 2: Chronic conditions among TB household contacts contacts in Tanzania, stratified by residence area (N = `r df_analysis %>% filter(Site == "Tanzania") %>% filter(complete.cases(Hhold_ResidenceArea)) %>% nrow()`)

```{r}
# Comorbidities with prevalence of more than 1%
temp <- df_analysis %>%
    select(Comorb_TBEver,
        Comorb_Hypertension,
        Comorb_Diabetes,
        Comorb_LungDis_Any,
        Comorb_LungDis_Asthma,
        Comorb_LungDis_LungCancer,
        Comorb_LungDis_ChestInj,
        Comorb_LungDis_COVID19,
        Comorb_LungDis_Pneumonia,
        Comorb_LungDis_Silicosis,
        Comorb_CVD,
        Comorb_CKD,
        Comorb_MentalHealth,
        #HistoryMining,
        #HistoryPrison
        ) %>%
    mutate(across(everything(), as.character)) %>%
    pivot_longer(everything()) %>%
    filter(value == "Yes") %>%
    group_by(name) %>%
    dplyr::summarize(N = n()) %>%
    mutate(perc = N/nrow(df_analysis)) %>%
    filter(perc >= 0.01)

temp

comorbs <- temp %>%
    select(name) %>%
    distinct() %>%
    pull()

df_analysis %>%
    filter(Site == "Tanzania") %>%
    dplyr::select(
        Hhold_ResidenceArea,
        Sex_Use,
        Age_Baseline,
        Age_Baseline_Cat_CJC,
        Education,
        Pregnancy_Status_Baseline,
        Smoking_Cat_Bin,
        Smoking_PackYears,
        AUDIT_Score_Cat_CJC,
        InsufficientFood,
        Comorb_HIV,
        HIV_ART_CJC,
        any_of(comorbs),
        Index_Relation
        ) %>%
    tbl_summary(by = Hhold_ResidenceArea) %>% 
    add_p() %>%
    add_overall() %>%
    bold_labels() %>%
    modify_footnote(all_stat_cols() ~ "n (%); median (interquartile range)") %>%
    as_flex_table() %>%
    add_footer_lines("1 person missing residence area not shown in table") %>%
    set_table_properties(layout = "autofit")
```

\newpage

```{r}
group = "All"
temp_df <- df_analysis %>%
    filter(Site == "Tanzania")

source(paste0(projdir, "Scripts/Tables/erase_prevalence_tanzrururb.R"))

prevalencetable_tanzrururb %>%
    mutate(Condition = ifelse(is.na(Condition), as.character(Category), as.character(Condition)),
           Level = case_when(
               Level == "Normal, SBP <130 / DBP<85" ~ "Normal BP",
               Level == "Prehypertension, SBP 130-139 / DBP 85-89" ~ "High-normal BP",
               Level == "Grade 1 hypertension, SBP 140-159 / DBP 90-99" ~ "Grade 1 hypertension",
               Level == "Grade 2 hypertension, SBP ≥160 / DBP ≥100" ~ "Grade 2 hypertension",
           complete.cases(Level) ~ as.character(Level))) %>%
    select(-Category) %>%
    flextable() %>%
    merge_v(j = ~ Condition) %>%
    valign(j = 1:2, valign = "top", part = "body") %>%
    align(j = 3:5, align = "center", part = "all") %>%
    merge_h(c(1, 19, 24)) %>%
    bold(part = "header") %>%
    style(i = c(1, 19, 24), 
        pr_t = fp_text_default(
          bold = TRUE)) %>%
    bg(i = c(1, 19, 24), bg = "#dadada") %>%
    hline(i = c(1, 18, 19, 23, 24), border = officer::fp_border(color="black", width = 1)) %>%
    set_table_properties(layout = "autofit") %>%
    add_footer_lines("1 person missing residence area not shown in table") 
```
